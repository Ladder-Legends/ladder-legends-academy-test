#!/bin/sh

# Detect Termux environment
IS_TERMUX=""
if [ -n "$TERMUX_VERSION" ] || [ -d "/data/data/com.termux" ]; then
  IS_TERMUX="true"
fi

echo "ğŸ” Running pre-push checks..."

# Run TypeScript type checking (skip in Termux - corrupted .next/types)
if [ -n "$IS_TERMUX" ]; then
  echo "â­ï¸  Skipping type check (Termux environment - corrupted .next types)"
else
  echo "ğŸ“ Type checking..."
  npx tsc --noEmit || exit 1
fi

# Run ESLint
echo "ğŸ”§ Linting..."
npm run lint || exit 1

# Skip build in Termux (native binaries not compatible)
if [ -n "$IS_TERMUX" ]; then
  echo "â­ï¸  Skipping build step (Termux environment - will build on Vercel)"
else
  # Run build to ensure it compiles (using separate build directory)
  echo "ğŸ—ï¸  Building (using .next-pre-push cache)..."
  NEXT_BUILD_DIR=.next-pre-push npm run build || exit 1

  # Clean up the pre-push build directory to save space
  rm -rf .next-pre-push
fi

echo "âœ… All checks passed! Pushing..."
